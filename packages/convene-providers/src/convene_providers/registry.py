"""Provider registry with factory pattern for STT, TTS, and LLM providers."""

from __future__ import annotations

import enum
import logging
from typing import Any

logger = logging.getLogger(__name__)


class ProviderType(enum.StrEnum):
    """Categories of providers managed by the registry."""

    STT = "stt"
    TTS = "tts"
    LLM = "llm"


class ProviderRegistry:
    """Registry for provider classes with factory-based instantiation.

    Maintains a mapping of (ProviderType, name) to provider classes.
    Supports registration, creation, and listing of providers.

    Example:
        registry = ProviderRegistry()
        registry.register(ProviderType.STT, "assemblyai", AssemblyAISTT)
        provider = registry.create(
            ProviderType.STT, "assemblyai", api_key="..."
        )
    """

    def __init__(self) -> None:
        """Initialize an empty provider registry."""
        self._providers: dict[tuple[ProviderType, str], type[Any]] = {}

    def register(
        self,
        provider_type: ProviderType,
        name: str,
        cls: type[Any],
    ) -> None:
        """Register a provider class under a type and name.

        Args:
            provider_type: The category of provider (STT, TTS, LLM).
            name: A unique name for this provider within its type.
            cls: The provider class to register.

        Raises:
            ValueError: If a provider with the same type and name is
                already registered.
        """
        key = (provider_type, name)
        if key in self._providers:
            msg = f"Provider already registered: {provider_type.value}/{name}"
            raise ValueError(msg)
        self._providers[key] = cls
        logger.debug(
            "Registered provider: %s/%s -> %s",
            provider_type.value,
            name,
            cls.__name__,
        )

    def create(
        self,
        provider_type: ProviderType,
        name: str,
        **kwargs: Any,
    ) -> Any:
        """Instantiate a registered provider with the given arguments.

        Args:
            provider_type: The category of provider to create.
            name: The registered name of the provider.
            **kwargs: Arguments to pass to the provider constructor.

        Returns:
            An instance of the registered provider class.

        Raises:
            KeyError: If no provider is registered with the given
                type and name.
        """
        key = (provider_type, name)
        cls = self._providers.get(key)
        if cls is None:
            available = self.list_providers(provider_type)
            msg = f"No provider registered for {provider_type.value}/{name}. Available: {available}"
            raise KeyError(msg)
        return cls(**kwargs)

    def list_providers(self, provider_type: ProviderType) -> list[str]:
        """List all registered provider names for a given type.

        Args:
            provider_type: The category of providers to list.

        Returns:
            Sorted list of registered provider names.
        """
        names = [name for (ptype, name) in self._providers if ptype == provider_type]
        return sorted(names)

    def is_registered(self, provider_type: ProviderType, name: str) -> bool:
        """Check whether a provider is registered.

        Args:
            provider_type: The category of provider.
            name: The provider name to check.

        Returns:
            True if the provider is registered, False otherwise.
        """
        return (provider_type, name) in self._providers


def _build_default_registry() -> ProviderRegistry:
    """Build a registry with all built-in providers pre-registered.

    Returns:
        A ProviderRegistry instance with default providers registered.
    """
    from convene_providers.llm.anthropic_llm import AnthropicLLM
    from convene_providers.stt.assemblyai_stt import AssemblyAISTT
    from convene_providers.stt.deepgram_stt import DeepgramSTT
    from convene_providers.tts.cartesia_tts import CartesiaTTS
    from convene_providers.tts.elevenlabs_tts import ElevenLabsTTS

    registry = ProviderRegistry()

    # STT providers
    registry.register(ProviderType.STT, "assemblyai", AssemblyAISTT)
    registry.register(ProviderType.STT, "deepgram", DeepgramSTT)

    # TTS providers
    registry.register(ProviderType.TTS, "cartesia", CartesiaTTS)
    registry.register(ProviderType.TTS, "elevenlabs", ElevenLabsTTS)

    # LLM providers
    registry.register(ProviderType.LLM, "anthropic", AnthropicLLM)

    return registry


#: Default singleton registry with all built-in providers.
default_registry: ProviderRegistry = _build_default_registry()
